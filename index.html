<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf GPS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease;
        }
        /* Style the theme toggle icon */
        .icon {
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
        /* Make the wake lock icon a bit thicker */
        #wake-lock-icon {
            stroke-width: 3;
        }
    </style>
</head>
<body class="bg-zinc-50 dark:bg-zinc-900 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white dark:bg-zinc-800 rounded-3xl shadow-2xl p-8 max-w-sm w-full mx-auto min-h-[80vh] flex flex-col justify-between transition-colors">

        <!-- Controls and Settings -->
        <div class="flex justify-between items-center mb-6">
            <!-- Dark Mode Toggle Button -->
            <button id="theme-toggle-btn" class="p-2 rounded-full text-zinc-800 dark:text-zinc-200 bg-zinc-200 dark:bg-zinc-700 hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors">
                <svg id="theme-icon" class="w-6 h-6 icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <!-- Sun icon by default -->
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
            </button>
            
            <!-- App Title and Course Info -->
            <div class="text-center flex-grow">
                <h1 id="course-name" class="text-2xl font-extrabold text-zinc-900 dark:text-zinc-100 mb-1 transition-colors"></h1>
                <p id="hole-info" class="text-md text-zinc-500 dark:text-zinc-400 font-medium transition-colors"></p>
            </div>
            
            <!-- Wake Lock Toggle Button -->
            <button id="wake-lock-btn" class="p-2 rounded-full text-zinc-800 dark:text-zinc-200 bg-zinc-200 dark:bg-zinc-700 hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors">
                <svg id="wake-lock-icon" class="w-6 h-6 icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
            </button>
        </div>

        <!-- Distance Display -->
        <div class="grid grid-cols-3 gap-4 text-center mb-6">
            <!-- Front of Green -->
            <div class="bg-teal-100 dark:bg-teal-900 rounded-2xl p-4 shadow-inner transition-colors">
                <p class="text-sm font-semibold text-zinc-600 dark:text-zinc-300">Front</p>
                <p id="distance-front" class="text-4xl font-black text-teal-700 dark:text-teal-300 mt-2">--</p>
                <p class="text-xs text-zinc-400 dark:text-zinc-500">yards</p>
            </div>
            <!-- Center of Green -->
            <div class="bg-teal-100 dark:bg-teal-900 rounded-2xl p-4 shadow-inner transition-colors">
                <p class="text-sm font-semibold text-zinc-600 dark:text-zinc-300">Center</p>
                <p id="distance-center" class="text-4xl font-black text-teal-700 dark:text-teal-300 mt-2">--</p>
                <p class="text-xs text-zinc-400 dark:text-zinc-500">yards</p>
            </div>
            <!-- Back of Green -->
            <div class="bg-teal-100 dark:bg-teal-900 rounded-2xl p-4 shadow-inner transition-colors">
                <p class="text-sm font-semibold text-zinc-600 dark:text-zinc-300">Back</p>
                <p id="distance-back" class="text-4xl font-black text-teal-700 dark:text-teal-300 mt-2">--</p>
                <p class="text-xs text-zinc-400 dark:text-zinc-500">yards</p>
            </div>
        </div>
        
        <!-- Hazard Display -->
        <div id="hazards-container" class="bg-orange-50 dark:bg-orange-900 rounded-2xl p-4 mb-6 shadow-inner transition-colors">
            <h3 class="text-center text-sm font-semibold text-orange-800 dark:text-orange-200 mb-2">Hazards</h3>
            <div id="hazards-list" class="text-center text-sm font-medium text-zinc-600 dark:text-zinc-400">
                <!-- Hazards will be dynamically added here -->
            </div>
        </div>

        <!-- Loading and Error Messages -->
        <p id="message-area" class="text-center text-sm font-medium h-6 text-zinc-600 dark:text-zinc-400"></p>

        <!-- Navigation and Actions -->
        <div class="flex items-center justify-between gap-4 mt-6">
            <button id="prev-hole-btn" class="flex-1 bg-zinc-200 dark:bg-zinc-700 text-zinc-700 dark:text-zinc-300 font-bold py-3 px-4 rounded-full shadow-md hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors">
                Previous
            </button>
            <button id="get-distance-btn" class="flex-1 bg-blue-600 text-white font-bold py-3 px-4 rounded-full shadow-lg hover:bg-blue-700 transition-colors transform hover:scale-105">
                Refresh
            </button>
            <button id="next-hole-btn" class="flex-1 bg-zinc-200 dark:bg-zinc-700 text-zinc-700 dark:text-zinc-300 font-bold py-3 px-4 rounded-full shadow-md hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors">
                Next
            </button>
        </div>
    </div>

    <script>
        // Use a self-invoking function to keep variables out of the global scope
        (function() {
            // ====================================================================
            // Step 1: Replace this mock course data with your own course details.
            //
            // The `tee` coordinates are now used to trigger the auto-advance feature.
            //
            // Format:
            // hole: the hole number
            // par: the par for the hole (optional, but good for context)
            // tee: [latitude, longitude] of the tee box for this hole
            // front: [latitude, longitude] of the front of the green
            // center: [latitude, longitude] of the center of the green
            // back: [latitude, longitude] of the back of the green
            // hazards: an array of objects, each with a name and location
            // ====================================================================
            const courseData = {
                name: "HadleyCreek",
                holes: [
                    { 
                        hole: 1, 
                        par: 3, 
                        tee: [44.075384, -92.431759], 
                        front: [44.074584, -92.432029], 
                        center: [44.074452, -92.432007], 
                        back: [44.074334, -92.431968],
                        hazards: []
                    },
                    { 
                        hole: 2, 
                        par: 4, 
                        tee: [44.073303, -92.431259], 
                        front: [44.074169, -92.434047], 
                        center: [44.074227, -92.434211], 
                        back: [44.074301, -92.434349],
                        hazards: [
                            { name: "Right Bunker", front: [44.073791332201665, -92.4325732153536], back: [44.073825055014325, -92.43290715036665] },
                            { name: "Left Bunker", front: [44.073681492048536, -92.43348248419395], back: [44.07386070482263, -92.43383653576203] }
                        ]
                    },
                    { 
                        hole: 3, 
                        par: 3, 
                        tee: [44.073554, -92.434544], 
                        front: [44.072758, -92.433836], 
                        center: [44.072678, -92.433714], 
                        back: [44.072582, -92.433597], 
                        hazards: [
                            { name: "Bunker", front: [44.07296298584522, -92.43384416400436], back: [44.0728455383541, -92.43355549598716] }
                        ]
                    },
                    { hole: 4, par: 3, tee: [44.072748, -92.434836], front: [44.073577, -92.435656], center: [44.073693, -92.435775], back: [44.073808, -92.435914], hazards: [] },
                    { hole: 5, par: 4, tee: [44.074034, -92.439247], front: [44.074087, -92.442439], center: [44.074133, -92.442610], back: [44.074181, -92.442764], hazards: [] },
                    { 
                        hole: 6, 
                        par: 3, 
                        tee: [44.073704, -92.443746], 
                        front: [44.073768, -92.444650], 
                        center: [44.073819, -92.444810], 
                        back: [44.073841, -92.444974], 
                        hazards: [
                            { name: "Water on Right", location: [44.07385845583365, -92.44452525640412] }
                        ]
                    },
                    { 
                        hole: 7, 
                        par: 4, 
                        tee: [44.075151, -92.445116], 
                        front: [44.074793, -92.441756], 
                        center: [44.074769, -92.441583], 
                        back: [44.074780, -92.441421], 
                        hazards: [
                            { name: "Water Carry", location: [44.074940693489815, -92.44377158818594] },
                            { name: "Bunker", front: [44.07491591503698, -92.44176348042092], back: [44.0749091706003, -92.44156700862273] }
                        ]
                    },
                    { hole: 8, par: 3, tee: [44.074850, -92.439902], front: [44.074910, -92.438149], center: [44.074950, -92.437983], back: [44.074989, -92.437890], hazards: [] },
                    { 
                        hole: 9, 
                        par: 4, 
                        tee: [44.074869, -92.436735], 
                        front: [44.075048, -92.433139], 
                        center: [44.075108, -92.433005], 
                        back: [44.075154, -92.432855], 
                        hazards: [
                            { name: "Bunker", front: [44.07517764620998, -92.43392076595802], back: [44.07522774749392, -92.43358414874744] }
                        ]
                    }
                ]
            };

            let currentHoleIndex = 0;
            const proximityThreshold = 40; // Distance in yards to trigger next hole from the tee box.

            // ====================================================================
            // Helper functions to handle the logic
            // ====================================================================
            
            // Haversine formula to calculate distance between two lat/lon points
            function haversine(lat1, lon1, lat2, lon2) {
                const R = 6371; // Earth's radius in km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                          Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                const distance_km = R * c;
                return distance_km * 1093.61; // Convert km to yards
            }

            // Function to update the UI with current hole and course info
            function updateUI() {
                const hole = courseData.holes[currentHoleIndex];
                document.getElementById('course-name').textContent = courseData.name;
                document.getElementById('hole-info').textContent = `Hole ${hole.hole} | Par ${hole.par}`;
            }

            // Function to calculate and display distances to the current hole
            function displayDistances(position) {
                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;
                const currentHole = courseData.holes[currentHoleIndex];
                
                const frontEl = document.getElementById('distance-front');
                const centerEl = document.getElementById('distance-center');
                const backEl = document.getElementById('distance-back');
                const hazardsListEl = document.getElementById('hazards-list');
                const hazardsContainerEl = document.getElementById('hazards-container');

                const distFront = haversine(userLat, userLon, currentHole.front[0], currentHole.front[1]);
                const distCenter = haversine(userLat, userLon, currentHole.center[0], currentHole.center[1]);
                const distBack = haversine(userLat, userLon, currentHole.back[0], currentHole.back[1]);

                frontEl.textContent = Math.round(distFront);
                centerEl.textContent = Math.round(distCenter);
                backEl.textContent = Math.round(distBack);

                // Clear previous hazard list
                hazardsListEl.innerHTML = '';
                
                // Dynamically add new hazard list
                if (currentHole.hazards && currentHole.hazards.length > 0) {
                    // Show the container if there are hazards
                    hazardsContainerEl.style.display = 'block';

                    currentHole.hazards.forEach(hazard => {
                        const hazardDiv = document.createElement('div');
                        // Determine the color class based on the hazard name
                        let colorClass = '';
                        if (hazard.name.includes("Bunker")) {
                            colorClass = 'text-orange-600 dark:text-orange-400';
                        } else if (hazard.name.includes("Water")) {
                            colorClass = 'text-sky-600 dark:text-sky-400';
                        }
                        
                        hazardDiv.className = `flex justify-between items-center my-1 ${colorClass}`;

                        // Check if the hazard has front/back coordinates or a single location
                        if (hazard.front && hazard.back) {
                            const distToFront = haversine(userLat, userLon, hazard.front[0], hazard.front[1]);
                            const distToBack = haversine(userLat, userLon, hazard.back[0], hazard.back[1]);
                            hazardDiv.innerHTML = `<span class="text-sm font-semibold">${hazard.name}</span> <span class="text-xl font-bold">${Math.round(distToFront)} / ${Math.round(distToBack)}<span class="text-xs font-normal"> yds</span></span>`;
                        } else if (hazard.location) {
                            const distToHazard = haversine(userLat, userLon, hazard.location[0], hazard.location[1]);
                            hazardDiv.innerHTML = `<span class="text-sm font-semibold">${hazard.name}</span> <span class="text-xl font-bold">${Math.round(distToHazard)}<span class="text-xs font-normal"> yds</span></span>`;
                        }
                        hazardsListEl.appendChild(hazardDiv);
                    });
                } else {
                    // Hide the container if there are no hazards
                    hazardsContainerEl.style.display = 'none';
                }
            }
            
            // Main function to watch the user's position and update the UI
            function watchGolfPosition() {
                const messageArea = document.getElementById('message-area');
                if ("geolocation" in navigator) {
                    messageArea.textContent = 'Watching your location...';

                    // Use watchPosition to get continuous location updates
                    navigator.geolocation.watchPosition(
                        (position) => {
                            const userLat = position.coords.latitude;
                            const userLon = position.coords.longitude;
                            
                            // Check if the user is near the next tee box to auto-advance
                            if (currentHoleIndex < courseData.holes.length - 1) {
                                const nextHole = courseData.holes[currentHoleIndex + 1];
                                const distToNextTee = haversine(userLat, userLon, nextHole.tee[0], nextHole.tee[1]);
                                
                                if (distToNextTee <= proximityThreshold) {
                                    currentHoleIndex++;
                                    updateUI();
                                    messageArea.textContent = `Auto-advanced to Hole ${courseData.holes[currentHoleIndex].hole}!`;
                                } else {
                                    // If not advancing, just display the current distances
                                    displayDistances(position);
                                    messageArea.textContent = 'Distances updated.';
                                }
                            } else {
                                // If on the last hole, just display distances
                                displayDistances(position);
                                messageArea.textContent = 'Distances updated.';
                            }
                        },
                        (error) => {
                            messageArea.textContent = 'Error: ' + error.message;
                            console.error("Geolocation error:", error);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 5000,
                            maximumAge: 0
                        }
                    );
                } else {
                    messageArea.textContent = "Geolocation is not supported by your browser.";
                }
            }

            // Event listeners for user interaction
            document.getElementById('next-hole-btn').addEventListener('click', () => {
                if (currentHoleIndex < courseData.holes.length - 1) {
                    currentHoleIndex++;
                    updateUI();
                }
            });

            document.getElementById('prev-hole-btn').addEventListener('click', () => {
                if (currentHoleIndex > 0) {
                    currentHoleIndex--;
                    updateUI();
                }
            });

            // The "Refresh" button will now manually trigger a location update and check
            document.getElementById('get-distance-btn').addEventListener('click', () => {
                // Since we are watching the position, a refresh is less critical,
                // but this button can force an an immediate re-calculation.
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        displayDistances(position);
                        document.getElementById('message-area').textContent = 'Manual refresh completed.';
                    },
                    (error) => {
                        document.getElementById('message-area').textContent = 'Error: ' + error.message;
                        console.error("Geolocation error:", error);
                    }
                );
            });

            // ====================================================================
            // NEW: Dark Mode Toggle Functionality
            // ====================================================================
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const themeIcon = document.getElementById('theme-icon');
            const body = document.body;

            // Check for saved theme preference in local storage or system preference
            const storedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            // Set initial theme
            if (storedTheme === 'dark' || (!storedTheme && prefersDark)) {
                body.classList.add('dark');
                themeIcon.innerHTML = `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>`;
            } else {
                body.classList.remove('dark');
                themeIcon.innerHTML = `<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>`;
            }

            // Handle theme toggle on button click
            themeToggleBtn.addEventListener('click', () => {
                body.classList.toggle('dark');
                if (body.classList.contains('dark')) {
                    localStorage.setItem('theme', 'dark');
                    themeIcon.innerHTML = `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>`;
                } else {
                    localStorage.setItem('theme', 'light');
                    themeIcon.innerHTML = `<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>`;
                }
            });

            // ====================================================================
            // NEW: Wake Lock Functionality
            // Prevents the screen from dimming/sleeping.
            // ====================================================================
            const wakeLockBtn = document.getElementById('wake-lock-btn');
            let wakeLockSentinel = null;

            async function requestWakeLock() {
                if ('wakeLock' in navigator) {
                    try {
                        wakeLockSentinel = await navigator.wakeLock.request('screen');
                        wakeLockBtn.style.backgroundColor = '#10B981'; // Tailwind's green-500
                        wakeLockBtn.style.color = '#FFFFFF';
                        wakeLockBtn.style.borderColor = '#10B981';
                        console.log('Wake Lock is active!');
                    } catch (err) {
                        console.error(`${err.name}, ${err.message}`);
                    }
                } else {
                    console.error("Wake Lock API not supported.");
                }
            }

            function releaseWakeLock() {
                if (wakeLockSentinel) {
                    wakeLockSentinel.release()
                        .then(() => {
                            wakeLockSentinel = null;
                            wakeLockBtn.style.backgroundColor = '';
                            wakeLockBtn.style.color = '';
                            wakeLockBtn.style.borderColor = '';
                            console.log('Wake Lock released.');
                        });
                }
            }

            wakeLockBtn.addEventListener('click', () => {
                if (wakeLockSentinel) {
                    releaseWakeLock();
                } else {
                    requestWakeLock();
                }
            });

            // Re-acquire the wake lock if the user navigates back to the app
            document.addEventListener('visibilitychange', () => {
                if (wakeLockSentinel !== null && document.visibilityState === 'visible') {
                    requestWakeLock();
                }
            });

            // Initial setup and start watching position
            updateUI();
            watchGolfPosition();
        })();
    </script>
</body>
</html>
